import {Controller, Get, MessageEvent, Res, Sse} from '@nestjs/common';
import {Response} from 'express';
import {readFileSync} from 'fs';
import {join} from 'path';
import {interval, Observable} from 'rxjs';
import {map} from 'rxjs/operators';

interface Stock {
    name: string;
    code: string;
    data: BarData;
}

interface BarData {
    time?: number;
    open?: number;
    high?: number;
    low?: number;
    close?: number;
    volume?: number;
}

@Controller()
export class AppController {

    symbols: string[] = ["BHK", "ABT", "MPC", "DDN", "PVR", "OPC", "BED", "BBC", "C12", "DRC", "TKC", "PNP", "HKB", "SAC", "HTN", "PIC", "HEP", "PMC", "PIT", "LCW", "VGP", "TCK", "HHS", "TTZ", "PVM", "QHW", "VDN", "SLS", "VNX", "HDA", "TCD", "EIC", "HFC", "SCR", "PTX", "VIH", "EVS", "PVL", "VFG", "NGC", "VNB", "TNG", "TAG", "BCM", "HU6", "RCC", "ABC", "VNR", "KIP", "TKG", "TNI", "HTC", "MIC", "TTT", "MSN", "EVE", "PRT", "BKH", "CLX", "NDN", "JOS", "UCT", "SBH", "IDJ", "LO5", "AUM", "VC6", "PNC", "VCP", "HNB", "TYA", "AAS", "NFC", "SRA", "VC3", "SGI", "KMT", "LCS", "NT2", "VTI", "ATG", "M10", "NAG", "HDP", "TXM", "DLG", "LGL", "VE8", "ABB", "SDA", "CCP", "LAF", "BTB", "DXV", "NAF", "CKD", "DOC", "SHC", "IDI", "SPB", "VCE", "VGV", "HUG", "ICG", "TNP", "TUG", "IMP", "PXI", "PLC", "SWC", "FCM", "PSW", "BTT", "PLX", "HSI", "KSD", "DAE", "PHN", "IDC", "BAB", "SJE", "VSG", "NDP", "NBB", "VET", "LDW", "ATS", "HLC", "H11", "MND", "TMG", "S99", "ADC", "BRS", "IST", "TKU", "TMP", "DPG", "HNI", "POW", "SHI", "CTI", "NS2", "VDB", "L62", "USD", "AGF", "TMW", "PVO", "APG", "RDP", "MTB", "ICN", "L44", "ATB", "BMD", "THU", "COM", "ITD", "BTS", "CLC", "EID", "IBN", "BSH", "HTE", "VTD", "THB", "PCN", "TMS", "VHF", "BMN", "TVD", "HAN", "CTA", "TIN", "HAT", "PMS", "QNT", "EIN", "SDV", "HPX", "VHH", "HC3", "ACG", "DTV", "DNA", "C47", "NSS", "DIG", "VAT", "CCI", "BCE", "VTJ", "FDC", "CMG", "VPI", "DPD", "BMI", "FHN", "SZC", "MTS", "BT6", "NXT", "ICF", "TCL", "PTP", "CE1", "CMX", "HTM", "BAX", "HVX", "SGS", "FTI", "ALT", "DNH", "MGR", "DCR", "TVN", "SVD", "VTH", "VE1", "PSB", "TPC", "SBL", "HBS", "TA3", "CPI", "TIX", "BHT", "PVA", "THS", "SPD", "BTW", "SVH", "PXA", "ADS", "DVN", "AGR", "TDH", "VGC", "QNW", "HEJ", "VLB", "TTB", "IJC", "TVT", "PFL", "HTI", "RBC", "HPG", "PCE", "DCS", "BNA", "TCM", "RAT", "PWA", "CST", "DBD", "VCW", "SMT", "DM7", "ICC", "BBH", "VGR", "CMT", "LM3", "CET", "TBH", "ARM", "DAS", "HU1", "BSI", "SED", "BRC", "AGX", "LCD", "SGD", "MBG", "HGT", "DHA", "STK", "ASP", "LYF", "CLG", "FLC", "XPH", "TA9", "TOS", "RCD", "PEN", "PPY", "TDW", "LWS", "PSE", "MTG", "VIT", "LKW", "SKH", "MPT", "VLG", "REE", "ABR", "THI", "HLT", "QBS", "ACE", "NAW", "S55", "NAC", "BHP", "VMS", "GDT", "NED", "MAC", "SSC", "VIW", "VHG", "SIC", "DHM", "MNB", "ACL", "C92", "D2D", "SBS", "TEG", "PPE", "HPH", "LEC", "DSG", "DAD", "VCA", "BCC", "LIG", "VKC", "UEM", "LGC", "TNW", "KDM", "VAB", "HHR", "MDF", "SGB", "CCV", "KSV", "HDM", "HEM", "HCM", "PPT", "SBA", "VSA", "PAP", "NSC", "TRT", "OIL", "DTB", "MLC", "PCH", "CSM", "HRC", "SCL", "MIE", "PCC", "NAV", "CMK", "DDH", "CTS", "HPD", "DNE", "SGT", "CEG", "HAF", "CMF", "NTP", "VCS", "BDG", "DDM", "ISG", "ONE", "DWS", "HPB", "MTC", "STT", "VRE", "HCT", "DQC", "HND", "PAN", "GE2", "DTL", "MA1", "OGC", "CSC", "VTL", "MBS", "ILS", "POB", "SPI", "GMX", "VPR", "NAU", "VSF", "AST", "SHB", "NHP", "L43", "INN", "ONW", "L40", "DFF", "XDH", "SJD", "HPM", "SD8", "GND", "SPH", "GTD", "AFX", "VHC", "VFC", "KCE", "MKV", "THN", "SHS", "CSI", "CQT", "CVP", "VC1", "VTS", "VTR", "PSP", "DST", "KTL", "DTP", "PLO", "ART", "THD", "SSM", "LMC", "BBM", "L18", "TA6", "IDP", "VXP", "PIV", "DCG", "VNY", "FGL", "TVB", "MDG", "CKA", "QPH", "PWS", "BMS", "TVA", "VGT", "CFM", "FRT", "MCP", "HAX", "USC", "BTG", "CRE", "TTH", "VPG", "PVG", "VND", "LIC", "CCT", "VIM", "TLT", "NSH", "LIX", "HU4", "TOP", "APL", "SGC", "HD2", "EMG", "SBV", "PBC", "SDK", "TIS", "KDH", "GMC", "NLG", "PDR", "PJC", "BOT", "NHT", "NAP", "MLS", "CTX", "CII", "BIG", "AAA", "SKG", "DNN", "KSB", "SAF", "TSC", "STC", "SDB", "HHV", "TVH", "CYC", "ADG", "SRF", "FIT", "GVT", "VOC", "CC4", "BLW", "XHC", "GMH", "BVB", "VQC", "PGI", "KLB", "PVY", "MEL", "SFN", "HPI", "AMS", "HKP", "GKM", "TPB", "KHP", "LAI", "MQB", "BEL", "ACM", "DAC", "LM7", "KTC", "PPI", "CAN", "VJC", "TCO", "SQC", "E12", "CNN", "ICI", "NQB", "VTG", "ELC", "CJC", "VPW", "TAW", "EVG", "GMA", "SHX", "CQN", "VIB", "HTT", "BSA", "ICT", "CDN", "VNT", "BTH", "V15", "CNA", "DSN", "TBR", "FOC", "VIX", "BCB", "VCC", "TTP", "HAM", "GLT", "CTW", "STL", "PAT", "GIC", "TCW", "NCT", "SSF", "S72", "HHC", "MPY", "MEF", "VNI", "FBC", "PNT", "ODE", "TQN", "EBS", "PTS", "BTP", "PTG", "DHG", "CMV", "VGG", "BSG", "VIE", "VEA", "EPH", "ITQ", "SAB", "HAS", "EIB", "KHG", "X77", "HFX", "CHC", "NDT", "MGC", "TPS", "HFB", "HTG", "HOT", "VHE", "IPA", "FCC", "BHG", "BQB", "TS3", "HBC", "ADP", "GER", "GEE", "DFC", "KHS", "NBT", "DGT", "HLS", "DUS", "PIA", "PTB", "CTC", "BVG", "TDF", "TOT", "TH1", "VAF", "VGL", "GSM", "PEG", "IBC", "NLS", "AAM", "RIC", "VIC", "DTE", "APH", "ACB", "CPA", "SAP", "NHA", "SCO", "CNG", "NTC", "HAI", "PBP", "GLC", "BAL", "SHG", "PVP", "DID", "SD7", "LCG", "VOS", "BLF", "PV2", "KHL", "SDT", "NDC", "TRC", "VDT", "QSP", "TVM", "TIG", "PMP", "CTD", "TSD", "PTN", "DP1", "TTE", "BDB", "HSL", "AGG", "NHH", "L10", "VSC", "VCF", "POS", "HVN", "BSP", "HAC", "CX8", "POM", "SD2", "DTC", "BCP", "GDW", "TBC", "HDW", "MVB", "CDC", "DVG", "NNC", "SCC", "WCS", "VST", "HVA", "C32", "LMI", "BSQ", "TMX", "MVC", "HTV", "SJG", "KDC", "VTZ", "NTL", "PTE", "PGV", "TMT", "IDV", "SVN", "LG9", "SNC", "TS4", "PVE", "TL4", "PEC", "SVC", "DNC", "DKC", "DXG", "TGP", "KSF", "NDX", "HSM", "ABI", "CNT", "TSG", "HJC", "HLA", "TV1", "TLD", "NSG", "PTV", "SGR", "TPH", "BIO", "SHE", "DBC", "TST", "BGW", "MIG", "HAR", "PVB", "GIL", "BKC", "NNT", "BHN", "DS3", "TC6", "VC7", "BRR", "BLI", "VW3", "TTC", "TVC", "PPP", "DWC", "SBT", "MCC", "HQC", "FID", "THT", "KOS", "ANV", "DTD", "HEV", "PRE", "NAB", "HD8", "NOS", "DCT", "ALV", "HPP", "SAM", "TDS", "DP3", "TDB", "X26", "DNW", "PMG", "HLG", "HHP", "ANT", "VKP", "PET", "C21", "APS", "BII", "TLP", "MCI", "DHD", "DBM", "A32", "TTG", "SPC", "STH", "HKT", "INC", "DZM", "VLF", "CTF", "BCG", "CH5", "VE3", "HBD", "TNB", "PXT", "PNJ", "DCH", "TDT", "SFG", "NTT", "LAS", "CIA", "HWS", "TBT", "TNC", "UIC", "GEG", "CTT", "TDP", "PTO", "DRL", "VVN", "VTV", "PX1", "FPT", "TV3", "NSL", "VTP", "SDP", "GTT", "HPW", "PTT", "NBC", "TMB", "VIR", "CPC", "ITC", "FSO", "VXB", "MBB", "DVC", "KKC", "C4G", "TIP", "STG", "LPT", "BHA", "CMC", "PPS", "GCB", "PMW", "L35", "TAN", "CKG", "CCL", "SII", "SZG", "CFV", "HTW", "MST", "QCG", "BIC", "MAS", "CBI", "TDG", "HNF", "MED", "APF", "HRT", "TSJ", "ILB", "JVC", "MCF", "CTN", "BWS", "SMN", "QST", "MCM", "MTH", "VMD", "LMH", "BLN", "NNG", "PMB", "TAR", "FIC", "DCF", "DIC", "TNS", "KVC", "AVF", "CAR", "VLC", "VTX", "LHC", "ILC", "SDU", "TW3", "SJ1", "LPB", "BCA", "MWG", "DTH", "SD6", "DOP", "VTK", "VE9", "MVN", "V21", "VDL", "CMP", "SCJ", "PGS", "CTP", "BTV", "TVP", "VSM", "SMA", "TDM", "MBN", "TCH", "G20", "SCD", "MCD", "OCH", "DP2", "GGG", "VCR", "THW", "MSR", "SDJ", "TLI", "DC2", "L61", "E29", "SMC", "BWE", "SHN", "HNA", "VFS", "DSC", "HLY", "ASA", "SZE", "DXS", "HDB", "TNA", "VGS", "AME", "SSI", "DSV", "UNI", "SKV", "NTW", "FCN", "GAB", "SP2", "DDV", "NDF", "TV4", "SPP", "DSD", "TVW", "HCC", "HIG", "DAT", "UDJ", "BMC", "TED", "GSP", "DAG", "PLE", "VNL", "VTA", "THG", "POV", "FTM", "CI5", "VPH", "WSB", "HU3", "ATA", "BAF", "VMG", "CLW", "BMJ", "PQN", "VGI", "CTB", "IBD", "HTH", "TEL", "PDN", "ECI", "BBS", "PSG", "TCT", "CSV", "DTG", "BMG", "AIC", "HDG", "ABS", "CRC", "API", "BXH", "BDT", "FCS", "SEB", "TSB", "TPP", "VTE", "HEC", "AVC", "MKP", "NHC", "CDH", "TTS", "DNM", "SJM", "APP", "TCB", "MEC", "QCC", "VTB", "FTS", "GTA", "TET", "LAW", "HID", "KGM", "LBM", "DLD", "HII", "VHM", "VPC", "VNC", "PJS", "GHC", "SDG", "GAS", "SCY", "DPP", "HMR", "HSP", "NDW", "LBC", "SJS", "S96", "HDO", "PHS", "SD3", "GEX", "FHS", "S12", "BSL", "EME", "SGN", "NTB", "OCB", "RTB", "VLW", "TTF", "HVT", "PEQ", "C69", "SDX", "BWA", "DVM", "NBP", "PAC", "ITS", "GH3", "MTP", "BDW", "QNC", "IFS", "CAD", "HT1", "BKG", "BCF", "MSH", "SZL", "X20", "QTP", "DGW", "MGG", "DDG", "QLT", "HD6", "TVS", "CDR", "HHG", "LDP", "EMS", "PVS", "DXL", "SFI", "VNA", "KTS", "VSP", "HCD", "TV6", "LHG", "SDD", "TV2", "DND", "DMN", "HTR", "VCM", "MCH", "NAS", "LTC", "SEA", "DMC", "HUB", "VNH", "AAV", "DVP", "NST", "CC1", "NKG", "AGP", "VWS", "APT", "DBW", "SB1", "HGM", "MDC", "VEC", "L12", "BSC", "CVN", "MTV", "ISH", "CAT", "DNT", "VC9", "YTC", "FT1", "VNM", "WTC", "MES", "PC1", "LCM", "GTH", "VRG", "FRC", "VSE", "HAP", "HSG", "PXM", "EVF", "L63", "NBE", "APC", "SSB", "KCB", "ITA", "CLH", "NUE", "BSD", "DPH", "HAH", "NVT", "IHK", "TCI", "TNT", "SSG", "SPV", "PLA", "HVH", "CLM", "HLR", "SRB", "SHA", "PPC", "PVI", "KBC", "BVS", "BSR", "CMD", "HTL", "STW", "TQW", "PCT", "VAV", "UDL", "ILA", "BCV", "STP", "HMC", "SGO", "SZB", "PTD", "EPC", "DNP", "ST8", "QNS", "DHC", "BT1", "BMF", "MTA", "DPM", "XMD", "PCM", "TTL", "SIV", "SD9", "PGN", "VPB", "PSH", "RAL", "VVS", "PTL", "DSP", "VPD", "PSC", "HMH", "HLD", "MHC", "CDG", "NJC", "HC1", "CDO", "TID", "BPC", "VUA", "VCB", "PHP", "TBX", "DBT", "HHN", "TDC", "UDC", "DXP", "POT", "TKA", "CLL", "PCG", "DNL", "HUT", "TLH", "YBM", "PID", "AMC", "SGP", "NTH", "YEG", "TCJ", "BLT", "CAG", "KHW", "MRF", "LDG", "AGM", "ACV", "PHR", "SFC", "MSB", "S4A", "BID", "DL1", "VTQ", "VCT", "HTP", "VE2", "XMC", "PVD", "CCR", "PRO", "NVL", "DPC", "SIP", "UPH", "PDC", "HDC", "VSI", "TNH", "UMC", "THP", "ORS", "MTL", "FRM", "PDV", "CHS", "PGC", "TIE", "VMC", "SVT", "VNP", "PTC", "AGE", "VE4", "NTF", "VEF", "PVV", "KAC", "VPS", "VTC", "PSI", "SNZ", "SAS", "TGG", "MIM", "FIR", "VRC", "PBT", "HAD", "VNG", "SC5", "PAS", "HCB", "DCM", "STS", "TCR", "CPH", "BMV", "SVI", "KSQ", "NVB", "CID", "TOW", "KTT", "LSG", "CAP", "VTM", "PVX", "PVH", "KMR", "QHD", "LUT", "KHD", "CVT", "MHL", "VES", "SDN", "UPC", "CTG", "VBC", "BVL", "V12", "MQN", "PXS", "PSD", "PIS", "VNF", "NET", "VIP", "PHH", "TBD", "VLA", "VMA", "EMC", "NVP", "KHA", "KLM", "NWT", "ND2", "CAV", "L45", "VBB", "TTD", "DAN", "VFR", "DRH", "PDB", "FMC", "HAV", "CCM", "AAT", "VHL", "CBS", "PND", "SDY", "KST", "D11", "SBR", "DC4", "V11", "B82", "ASG", "BTU", "VNE", "PTH", "DHB", "HAG", "DRI", "XLV", "AG1", "VC2", "DHN", "SD5", "CAB", "MDA", "TR1", "TVG", "VDS", "CT6", "DRG", "HCI", "IVS", "CHP", "BFC", "BBT", "MCG", "MML", "LTG", "FBA", "BTN", "BHC", "VSH", "TTA", "SRT", "RCL", "AMD", "DTI", "EFI", "BST", "VIN", "HNR", "CMN", "HRB", "SEP", "IN4", "NBW", "VC5", "DC1", "CEN", "PLP", "NQT", "PTI", "PSN", "PPH", "TMC", "NCS", "HNG", "SDC", "MH3", "SBM", "VNS", "DTK", "VIF", "LCC", "VSN", "SCS", "CMS", "DGC", "SIG", "HBH", "DCL", "SRC", "NQN", "PVC", "HPT", "HSA", "VCG", "VDP", "HVG", "VBH", "VCX", "BMP", "LM8", "CCA", "CEO", "VTO", "PGD", "HMG", "PJT", "ASM", "DAH", "QTC", "STB", "FOX", "ACS", "HMS", "PCF", "NHV", "PGB", "DHP", "SD1", "MFS", "SJC", "PNG", "L14", "NRC", "LBE", "BTD", "CGV", "PAI", "PHC", "KPF", "DPR", "YBC", "SBD", "S27", "AMV", "TTN", "TB8", "PXL", "SCG", "CIG", "HLB", "BVH", "BNW", "TFC", "WSS", "GTS", "GLW", "PXC", "G36", "SMB", "SAV", "SKN", "CMW", "HES", "SHP", "BVN", "VPA", "KLF", "VID", "LGM", "CIP", "ACC", "TDN", "DTT", "KSH", "TRA", "DVW", "TJC", "SGH", "PRC", "CT3", "SID", "VHD", "XMP", "AMP", "S74", "DLR", "VCI", "DLT", "SCV", "HSV", "VIG", "CDP", "TRS", "LSS", "SSH", "DPS", "PGT", "PMJ", "GVR", "HGW", "CNC", "SCI", "LQN", "VXT", "CKV", "PVT", "VLP", "GMD", "IRC", "HNM", "DIH", "HOM", "RGC", "LNC", "PMT", "MCO", "CMI", "SSN", "DTA", "PSL", "SPM", "VBG", "IME", "HJS", "TN1", "SJF", "SD4", "SVG", "HNP", "DHT", "LLM", "SAL", "C22", "QNU", "CTR", "TNM", "TLG"];

    @Get()
    index(@Res() response: Response) {
        response
            .type('text/html')
            .send(readFileSync(join(__dirname, 'index.html')).toString());
    }

    @Sse('sse')
    sse(): Observable<MessageEvent> {
        return interval(50).pipe(
            map((_) => {
                return ({
                    data: {
                        symbols: this.symbols,
                        stockPrices: this.symbols.map(x => ({
                            time: new Date().getTime(),
                            open: Math.round(Math.random() * 300 - 150),
                            close: Math.round(Math.random() * 300 - 150),
                            high: Math.round(Math.random() * 300 - 150),
                            low: Math.round(Math.random() * 300 - 150),
                            volume: Math.round(Math.random() * 300 - 150)
                        })) as BarData[]
                    }
                } as MessageEvent)
            }),
        );
    }
}

// https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=frt&interval=1min&apikey=8J157YWL897O9P5A
